<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>干支历法工具</title>
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 24px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .form-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    label {
      font-size: 14px;
      color: #555;
    }

    input[type="date"],
    input[type="time"],
    select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }

    input[type="date"]:focus,
    input[type="time"]:focus,
    select:focus {
      border-color: #3498db;
    }

    input[type="radio"] {
      margin-right: 4px;
    }

    input[type="checkbox"] {
      margin-right: 6px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
    }

    .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-secondary {
      background-color: #ecf0f1;
      color: #333;
    }

    .btn-secondary:hover {
      background-color: #ddd;
    }

    .btn-primary {
      background-color: #3498db;
      color: white;
      width: 100%;
      padding: 12px;
      font-size: 16px;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .coord-display {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }

    .coord-display span {
      margin-right: 15px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
    }

    /* 结果区域 */
    .result-placeholder {
      text-align: center;
      color: #999;
      padding: 30px;
      font-size: 14px;
    }

    .result-content {
      display: none;
    }

    .result-content.show {
      display: block;
    }

    .true-solar-time {
      background: #e8f4f8;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
      display: none;
    }

    .true-solar-time.show {
      display: block;
    }

    .lunar-date {
      font-size: 16px;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .pillars {
      display: flex;
      justify-content: space-around;
      margin-bottom: 15px;
    }

    .pillar {
      text-align: center;
      flex: 1;
    }

    .pillar-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 5px;
    }

    .pillar-value {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }

    .pillar-value .gan {
      color: #e74c3c;
    }

    .pillar-value .zhi {
      color: #3498db;
    }

    .futou-sanyuan {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      font-size: 14px;
    }

    .futou-sanyuan span {
      color: #666;
    }

    .futou-sanyuan strong {
      color: #2c3e50;
    }

    /* 节气区域 */
    .jieqi-item {
      margin-bottom: 12px;
    }

    .jieqi-item:last-child {
      margin-bottom: 0;
    }

    .jieqi-name {
      font-weight: bold;
      color: #2c3e50;
    }

    .jieqi-time {
      color: #666;
      font-size: 14px;
    }

    .jieqi-distance {
      color: #999;
      font-size: 13px;
      margin-top: 2px;
    }

    /* 奇门遁甲 */
    .qimen-info {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .qimen-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qimen-label {
      color: #666;
      font-size: 14px;
    }

    .qimen-ju {
      margin-top: 5px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }

    .qimen-ju strong {
      font-size: 20px;
      color: #e74c3c;
    }

    .qimen-adjust {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .qimen-adjust-title {
      font-size: 13px;
      color: #999;
      margin-bottom: 10px;
    }

    .qimen-adjust-row {
      display: flex;
      gap: 20px;
      margin-bottom: 12px;
    }

    .qimen-adjust-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qimen-adjust-item label {
      font-size: 14px;
      color: #666;
    }

    .qimen-adjust-item select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .qimen-adjust-result {
      margin-bottom: 12px;
      font-size: 14px;
      color: #666;
    }

    .qimen-adjust-result strong {
      font-size: 18px;
      color: #27ae60;
      margin-left: 8px;
    }

    .btn-confirm {
      background-color: #27ae60;
      color: white;
      padding: 8px 20px;
    }

    .btn-confirm:hover {
      background-color: #219a52;
    }

    /* 值符值使 */
    .qimen-leaders {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .qimen-leaders-title {
      font-size: 13px;
      color: #999;
      margin-bottom: 10px;
    }

    .qimen-leaders-row {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 15px;
    }

    .qimen-leader-item {
      text-align: center;
    }

    .qimen-leader-label {
      font-size: 12px;
      color: #999;
      display: block;
      margin-bottom: 4px;
    }

    .qimen-leader-item strong {
      font-size: 18px;
      color: #8e44ad;
    }

    /* 洛书九宫 */
    .luoshu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-width: 300px;
      margin: 0 auto;
    }

    .luoshu-cell {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px solid #e9ecef;
      transition: all 0.2s;
    }

    .luoshu-cell:hover {
      border-color: #3498db;
      background: #e8f4f8;
    }

    .luoshu-num {
      font-size: 28px;
      font-weight: bold;
      color: #2c3e50;
    }

    .luoshu-gua {
      font-size: 14px;
      color: #666;
      margin-top: 2px;
    }

    .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .luoshu-center:hover {
      background: #ffecb5;
      border-color: #e0a800;
    }

    .luoshu-center .luoshu-num {
      color: #856404;
    }

    /* 奇门地盘 */
    .dipan-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }

    .dipan-grid .luoshu-cell {
      background: #e8f5e9;
      border-color: #a5d6a7;
    }

    .dipan-grid .luoshu-cell:hover {
      background: #c8e6c9;
      border-color: #66bb6a;
    }

    .dipan-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .dipan-stem {
      font-size: 32px;
      font-weight: bold;
      color: #2e7d32;
    }

    .dipan-grid .luoshu-center .dipan-stem {
      color: #856404;
    }

    /* 奇门天盘 */
    .tianpan-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .tianpan-info strong {
      color: #1565c0;
    }

    .tianpan-grid .luoshu-cell {
      background: #e3f2fd;
      border-color: #90caf9;
    }

    .tianpan-grid .luoshu-cell:hover {
      background: #bbdefb;
      border-color: #42a5f5;
    }

    .tianpan-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .tianpan-star {
      font-size: 18px;
      font-weight: bold;
      color: #1565c0;
    }

    .tianpan-grid .luoshu-center .tianpan-star {
      color: #856404;
    }

    /* 九星带干 */
    .star-name {
      display: block;
      font-size: 16px;
      font-weight: bold;
      color: #1565c0;
    }

    .star-stem {
      display: block;
      font-size: 14px;
      color: #e74c3c;
      margin-top: 2px;
    }

    .tianpan-grid .luoshu-center .star-name {
      color: #856404;
    }

    /* 九星原始宫位干 */
    .star-stem-info {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }

    .starstem-grid .luoshu-cell {
      background: #fce4ec;
      border-color: #f8bbd9;
    }

    .starstem-grid .luoshu-cell:hover {
      background: #f8bbd9;
      border-color: #f06292;
    }

    .starstem-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .starstem-star {
      font-size: 16px;
      font-weight: bold;
      color: #c2185b;
    }

    .starstem-gan {
      font-size: 24px;
      font-weight: bold;
      color: #e74c3c;
      margin: 2px 0;
    }

    .starstem-grid .luoshu-center .starstem-star {
      color: #856404;
    }

    .starstem-grid .luoshu-center .starstem-gan {
      color: #856404;
    }

    /* 八门原始宫位 */
    .door-origin-grid .luoshu-cell {
      background: #ede7f6;
      border-color: #b39ddb;
    }

    .door-origin-grid .luoshu-cell:hover {
      background: #d1c4e9;
      border-color: #9575cd;
    }

    .door-origin-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .door-origin-name {
      font-size: 20px;
      font-weight: bold;
      color: #512da8;
    }

    .door-origin-grid .luoshu-center .door-origin-name {
      color: #856404;
    }

    /* 奇门八门 */
    .door-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .door-info strong {
      color: #6a1b9a;
    }

    .door-grid .luoshu-cell {
      background: #f3e5f5;
      border-color: #ce93d8;
    }

    .door-grid .luoshu-cell:hover {
      background: #e1bee7;
      border-color: #ab47bc;
    }

    .door-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .door-name {
      font-size: 20px;
      font-weight: bold;
      color: #6a1b9a;
    }

    .door-angan {
      font-size: 14px;
      color: #e74c3c;
      margin-top: 2px;
    }

    .door-grid .luoshu-center .door-name {
      color: #856404;
    }

    .door-grid .luoshu-center .door-angan {
      color: #856404;
    }

    /* 奇门八神 */
    .shen-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }

    .shen-info strong {
      color: #00695c;
    }

    .shen-grid .luoshu-cell {
      background: #e0f2f1;
      border-color: #80cbc4;
    }

    .shen-grid .luoshu-cell:hover {
      background: #b2dfdb;
      border-color: #26a69a;
    }

    .shen-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .shen-name {
      font-size: 20px;
      font-weight: bold;
      color: #00695c;
    }

    .shen-grid .luoshu-center .shen-name {
      color: #856404;
    }

    /* 空亡马星 */
    .kongwang-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kongwang-info .info-row {
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .kongwang-info strong {
      color: #d84315;
    }

    .kongwang-grid .luoshu-cell {
      background: #fff8e1;
      border-color: #ffcc80;
      position: relative;
    }

    .kongwang-grid .luoshu-cell:hover {
      background: #ffecb3;
      border-color: #ffb74d;
    }

    .kongwang-grid .luoshu-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .kongwang-grid .luoshu-cell.has-kong {
      background: #ffebee;
      border-color: #ef9a9a;
    }

    .kongwang-grid .luoshu-cell.has-ma {
      background: #e3f2fd;
      border-color: #90caf9;
    }

    .kongwang-grid .luoshu-cell.has-both {
      background: linear-gradient(135deg, #ffebee 50%, #e3f2fd 50%);
      border-color: #ce93d8;
    }

    .kong-badge {
      display: inline-block;
      background: #ef5350;
      color: white;
      font-size: 14px;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 4px;
      margin: 2px;
    }

    .ma-badge {
      display: inline-block;
      background: #2196f3;
      color: white;
      font-size: 14px;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 4px;
      margin: 2px;
    }

    /* 综合奇门盘 */
    .qimen-pan-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      max-width: 100%;
      margin: 15px auto;
    }

    .qimen-pan-cell {
      background: #fafafa;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      min-height: 100px;
    }

    .qimen-pan-cell.center-cell {
      background: #fff8e1;
      border-color: #ffb74d;
    }

    .qimen-pan-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex: 1;
    }

    .qimen-pan-row.row-1 {
      border-bottom: 1px dashed #e0e0e0;
      padding-bottom: 4px;
    }

    .qimen-pan-row.row-2 {
      border-bottom: 1px dashed #e0e0e0;
      padding-bottom: 4px;
      padding-top: 4px;
    }

    .qimen-pan-row.row-3 {
      padding-top: 4px;
    }

    /* 第一行元素 */
    .pan-angan {
      font-size: 14px;
      font-weight: bold;
      color: #e74c3c;
      min-width: 20px;
    }

    .pan-shen {
      font-size: 14px;
      font-weight: bold;
      color: #00695c;
    }

    .pan-markers {
      display: flex;
      gap: 2px;
    }

    .pan-markers .kong-badge,
    .pan-markers .ma-badge {
      font-size: 11px;
      padding: 1px 4px;
    }

    /* 第二行元素 */
    .pan-star {
      font-size: 14px;
      font-weight: bold;
      color: #1565c0;
      flex: 1;
      text-align: center;
    }

    .pan-star-stem {
      font-size: 13px;
      color: #c2185b;
      min-width: 30px;
      text-align: right;
    }

    /* 第三行元素 */
    .pan-door {
      font-size: 14px;
      font-weight: bold;
      color: #6a1b9a;
      flex: 1;
      text-align: center;
    }

    .pan-dipan {
      font-size: 18px;
      font-weight: bold;
      color: #2e7d32;
      min-width: 20px;
      text-align: right;
    }

    /* 宫位标签 */
    .pan-gong-label {
      font-size: 11px;
      color: #999;
      text-align: center;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #eee;
    }

    /* 中宫特殊样式 */
    .qimen-pan-cell.center-cell .pan-dipan {
      color: #f57c00;
    }

    /* 图例 */
    .qimen-legend {
      margin-top: 15px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }

    .qimen-legend-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }

    .qimen-legend-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      max-width: 200px;
      margin: 0 auto 10px;
      background: white;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .legend-cell {
      text-align: center;
      padding: 2px;
      font-size: 11px;
    }

    .legend-row {
      display: contents;
    }

    .qimen-legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .legend-color.angan { background: #e74c3c; }
    .legend-color.shen { background: #00695c; }
    .legend-color.star { background: #1565c0; }
    .legend-color.stem { background: #c2185b; }
    .legend-color.door { background: #6a1b9a; }
    .legend-color.dipan { background: #2e7d32; }

    /* 位置选择器 */
    .location-selector {
      margin-top: 10px;
    }

    #citySelect {
      flex: 1;
      min-width: 150px;
    }

    #getLocationBtn {
      white-space: nowrap;
    }

    .hidden {
      display: none !important;
    }

    /* 响应式 */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .form-row {
        flex-direction: column;
        align-items: stretch;
      }

      .radio-group {
        flex-direction: column;
        gap: 10px;
      }

      input[type="date"],
      input[type="time"],
      select {
        width: 100%;
      }

      .pillars {
        flex-wrap: wrap;
        gap: 10px;
      }

      .pillar {
        flex: 0 0 45%;
      }
    }

    /* 可折叠详情板块 */
    .collapsible-section {
      background: white;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }

    .collapsible-header:hover {
      background-color: #f8f9fa;
    }

    .collapsible-icon {
      font-size: 12px;
      margin-right: 10px;
      transition: transform 0.3s;
      color: #666;
    }

    .collapsible-section.expanded .collapsible-icon {
      transform: rotate(90deg);
    }

    .collapsible-title {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .collapsible-section.expanded .collapsible-content {
      max-height: 3000px;
    }

    .collapsible-inner {
      padding: 0 15px 15px;
    }

    /* 紧凑模块网格布局 */
    .compact-modules-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width: 600px) {
      .compact-modules-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 紧凑模块卡片 */
    .compact-module {
      background: #fafafa;
      border-radius: 6px;
      padding: 10px;
      border: 1px solid #eee;
    }

    .compact-module-title {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
      font-weight: 500;
    }

    /* 紧凑九宫格 */
    .compact-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 4px;
      max-width: 180px;
      margin: 0 auto;
    }

    .compact-cell {
      min-height: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      padding: 4px 2px;
      font-size: 10px;
    }

    .compact-cell .luoshu-num {
      font-size: 16px;
    }

    .compact-cell .luoshu-gua {
      font-size: 10px;
      margin-top: 0;
    }

    .compact-cell .dipan-stem {
      font-size: 18px;
    }

    .compact-cell .tianpan-star {
      font-size: 12px;
    }

    .compact-cell .star-name {
      font-size: 11px;
      display: block;
    }

    .compact-cell .star-stem {
      font-size: 10px;
      display: block;
    }

    .compact-cell .starstem-star {
      font-size: 10px;
    }

    .compact-cell .starstem-gan {
      font-size: 14px;
      margin: 0;
    }

    .compact-cell .door-origin-name {
      font-size: 12px;
    }

    .compact-cell .door-name {
      font-size: 12px;
    }

    .compact-cell .door-angan {
      font-size: 10px;
      margin-top: 0;
    }

    .compact-cell .shen-name {
      font-size: 12px;
    }

    .compact-cell .kong-badge,
    .compact-cell .ma-badge {
      font-size: 10px;
      padding: 1px 4px;
    }

    /* 紧凑信息行 */
    .compact-info {
      text-align: center;
      font-size: 11px;
      color: #666;
      margin-bottom: 6px;
    }

    .compact-info strong {
      color: #333;
    }

    /* 紧凑中宫样式 */
    .compact-cell.compact-center {
      background: #fff3cd;
      border-color: #ffc107;
    }

    /* 各模块紧凑颜色 */
    .compact-luoshu .compact-cell {
      background: #f8f9fa;
    }

    .compact-dipan .compact-cell {
      background: #e8f5e9;
      border-color: #a5d6a7;
    }

    .compact-tianpan .compact-cell {
      background: #e3f2fd;
      border-color: #90caf9;
    }

    .compact-starstem .compact-cell {
      background: #fce4ec;
      border-color: #f8bbd9;
    }

    .compact-doororigin .compact-cell {
      background: #ede7f6;
      border-color: #b39ddb;
    }

    .compact-door .compact-cell {
      background: #f3e5f5;
      border-color: #ce93d8;
    }

    .compact-shen .compact-cell {
      background: #e0f2f1;
      border-color: #80cbc4;
    }

    .compact-kongwang .compact-cell {
      background: #fff8e1;
      border-color: #ffcc80;
    }

    .compact-kongwang .compact-cell.has-kong {
      background: #ffebee;
      border-color: #ef9a9a;
    }

    .compact-kongwang .compact-cell.has-ma {
      background: #e3f2fd;
      border-color: #90caf9;
    }

    .compact-kongwang .compact-cell.has-both {
      background: linear-gradient(135deg, #ffebee 50%, #e3f2fd 50%);
      border-color: #ce93d8;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>干支历法工具</h1>

    <!-- 时间选择 -->
    <div class="card">
      <div class="card-title">时间选择</div>
      <div class="form-row">
        <input type="date" id="dateInput">
        <input type="time" id="timeInput">
        <button class="btn btn-secondary" id="nowBtn">当前时刻</button>
      </div>
    </div>

    <!-- 位置设置 -->
    <div class="card">
      <div class="card-title">位置设置</div>
      <div class="form-row">
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="locationType" value="city" checked>
            选择城市
          </label>
          <label class="radio-label">
            <input type="radio" name="locationType" value="gps">
            获取当前位置
          </label>
        </div>
      </div>
      <div class="form-row location-selector">
        <select id="citySelect">
          <option value="">请选择城市</option>
        </select>
        <button class="btn btn-secondary hidden" id="getLocationBtn">获取位置</button>
      </div>
      <div class="coord-display">
        <span>经度: <strong id="lngDisplay">--</strong></span>
        <span>纬度: <strong id="latDisplay">--</strong></span>
      </div>
      <div class="form-row" style="margin-top: 12px;">
        <label class="checkbox-label">
          <input type="checkbox" id="useTrueSolarTime">
          使用真太阳时
        </label>
      </div>
    </div>

    <!-- 开始计算按钮 -->
    <div class="card" style="padding: 15px;">
      <button class="btn btn-primary" id="calculateBtn">开始计算</button>
    </div>

    <!-- 历法显示 -->
    <div class="card">
      <div class="card-title">历法信息</div>
      <div class="result-placeholder" id="resultPlaceholder">
        请设置时间和位置后点击「开始计算」
      </div>
      <div class="result-content" id="resultContent">
        <div class="true-solar-time" id="trueSolarTimeDisplay">
          真太阳时: <strong id="trueSolarTimeValue"></strong>
        </div>
        <div class="lunar-date">
          农历: <strong id="lunarDateValue"></strong>
        </div>
        <div class="pillars">
          <div class="pillar">
            <div class="pillar-label">年柱</div>
            <div class="pillar-value" id="yearPillar"></div>
          </div>
          <div class="pillar">
            <div class="pillar-label">月柱</div>
            <div class="pillar-value" id="monthPillar"></div>
          </div>
          <div class="pillar">
            <div class="pillar-label">日柱</div>
            <div class="pillar-value" id="dayPillar"></div>
          </div>
          <div class="pillar">
            <div class="pillar-label">时柱</div>
            <div class="pillar-value" id="hourPillar"></div>
          </div>
        </div>
        <div class="futou-sanyuan">
          <div><span>符头: </span><strong id="futouValue"></strong></div>
          <div><span>三元: </span><strong id="sanyuanValue"></strong></div>
        </div>
      </div>
    </div>

    <!-- 奇门遁甲 -->
    <div class="card">
      <div class="card-title">奇门遁甲</div>
      <div class="result-placeholder" id="qimenPlaceholder">
        请设置时间后点击「开始计算」
      </div>
      <div class="result-content" id="qimenContent">
        <div class="qimen-info">
          <div class="qimen-item">
            <span class="qimen-label">当前节气:</span>
            <strong id="qimenJieqi"></strong>
          </div>
          <div class="qimen-item">
            <span class="qimen-label">三元:</span>
            <strong id="qimenSanyuan"></strong>
          </div>
          <div class="qimen-item qimen-ju">
            <span class="qimen-label">推算局数:</span>
            <strong id="qimenJu"></strong>
          </div>
        </div>
        <div class="qimen-adjust">
          <div class="qimen-adjust-title">手动调整</div>
          <div class="qimen-adjust-row">
            <div class="qimen-adjust-item">
              <label>阴阳遁:</label>
              <select id="yinYangSelect">
                <option value="阳遁">阳遁</option>
                <option value="阴遁">阴遁</option>
              </select>
            </div>
            <div class="qimen-adjust-item">
              <label>局数:</label>
              <select id="juShuSelect">
                <option value="一">一局</option>
                <option value="二">二局</option>
                <option value="三">三局</option>
                <option value="四">四局</option>
                <option value="五">五局</option>
                <option value="六">六局</option>
                <option value="七">七局</option>
                <option value="八">八局</option>
                <option value="九">九局</option>
              </select>
            </div>
          </div>
          <div class="qimen-adjust-result">
            <span>调整后:</span>
            <strong id="adjustedJu"></strong>
          </div>
          <button class="btn btn-confirm" id="confirmAdjustBtn">确认调整</button>
        </div>
        <div class="qimen-leaders">
          <div class="qimen-leaders-title">值符值使</div>
          <div class="qimen-leaders-row">
            <div class="qimen-leader-item">
              <span class="qimen-leader-label">旬首:</span>
              <strong id="xunShouValue">--</strong>
            </div>
            <div class="qimen-leader-item">
              <span class="qimen-leader-label">值符:</span>
              <strong id="zhiFuValue">--</strong>
            </div>
            <div class="qimen-leader-item">
              <span class="qimen-leader-label">值使:</span>
              <strong id="zhiShiValue">--</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 奇门综合盘 -->
    <div class="card">
      <div class="card-title">奇门综合盘</div>
      <div class="result-placeholder" id="qimenPanPlaceholder">
        请先计算局数
      </div>
      <div class="result-content" id="qimenPanContent">
        <div class="qimen-pan-grid">
          <!-- 巽四宫 -->
          <div class="qimen-pan-cell" id="pan-cell-4">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-4"></span>
              <span class="pan-shen" id="pan-shen-4"></span>
              <div class="pan-markers" id="pan-markers-4"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-4"></span>
              <span class="pan-star-stem" id="pan-stem-4"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-4"></span>
              <span class="pan-dipan" id="pan-dipan-4"></span>
            </div>
            <div class="pan-gong-label">巽四宫</div>
          </div>
          <!-- 离九宫 -->
          <div class="qimen-pan-cell" id="pan-cell-9">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-9"></span>
              <span class="pan-shen" id="pan-shen-9"></span>
              <div class="pan-markers" id="pan-markers-9"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-9"></span>
              <span class="pan-star-stem" id="pan-stem-9"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-9"></span>
              <span class="pan-dipan" id="pan-dipan-9"></span>
            </div>
            <div class="pan-gong-label">离九宫</div>
          </div>
          <!-- 坤二宫 -->
          <div class="qimen-pan-cell" id="pan-cell-2">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-2"></span>
              <span class="pan-shen" id="pan-shen-2"></span>
              <div class="pan-markers" id="pan-markers-2"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-2"></span>
              <span class="pan-star-stem" id="pan-stem-2"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-2"></span>
              <span class="pan-dipan" id="pan-dipan-2"></span>
            </div>
            <div class="pan-gong-label">坤二宫</div>
          </div>
          <!-- 震三宫 -->
          <div class="qimen-pan-cell" id="pan-cell-3">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-3"></span>
              <span class="pan-shen" id="pan-shen-3"></span>
              <div class="pan-markers" id="pan-markers-3"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-3"></span>
              <span class="pan-star-stem" id="pan-stem-3"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-3"></span>
              <span class="pan-dipan" id="pan-dipan-3"></span>
            </div>
            <div class="pan-gong-label">震三宫</div>
          </div>
          <!-- 中五宫 -->
          <div class="qimen-pan-cell center-cell" id="pan-cell-5">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-5"></span>
              <span class="pan-shen" id="pan-shen-5"></span>
              <div class="pan-markers" id="pan-markers-5"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-5"></span>
              <span class="pan-star-stem" id="pan-stem-5"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-5"></span>
              <span class="pan-dipan" id="pan-dipan-5"></span>
            </div>
            <div class="pan-gong-label">中五宫</div>
          </div>
          <!-- 兑七宫 -->
          <div class="qimen-pan-cell" id="pan-cell-7">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-7"></span>
              <span class="pan-shen" id="pan-shen-7"></span>
              <div class="pan-markers" id="pan-markers-7"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-7"></span>
              <span class="pan-star-stem" id="pan-stem-7"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-7"></span>
              <span class="pan-dipan" id="pan-dipan-7"></span>
            </div>
            <div class="pan-gong-label">兑七宫</div>
          </div>
          <!-- 艮八宫 -->
          <div class="qimen-pan-cell" id="pan-cell-8">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-8"></span>
              <span class="pan-shen" id="pan-shen-8"></span>
              <div class="pan-markers" id="pan-markers-8"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-8"></span>
              <span class="pan-star-stem" id="pan-stem-8"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-8"></span>
              <span class="pan-dipan" id="pan-dipan-8"></span>
            </div>
            <div class="pan-gong-label">艮八宫</div>
          </div>
          <!-- 坎一宫 -->
          <div class="qimen-pan-cell" id="pan-cell-1">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-1"></span>
              <span class="pan-shen" id="pan-shen-1"></span>
              <div class="pan-markers" id="pan-markers-1"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-1"></span>
              <span class="pan-star-stem" id="pan-stem-1"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-1"></span>
              <span class="pan-dipan" id="pan-dipan-1"></span>
            </div>
            <div class="pan-gong-label">坎一宫</div>
          </div>
          <!-- 乾六宫 -->
          <div class="qimen-pan-cell" id="pan-cell-6">
            <div class="qimen-pan-row row-1">
              <span class="pan-angan" id="pan-angan-6"></span>
              <span class="pan-shen" id="pan-shen-6"></span>
              <div class="pan-markers" id="pan-markers-6"></div>
            </div>
            <div class="qimen-pan-row row-2">
              <span class="pan-star" id="pan-star-6"></span>
              <span class="pan-star-stem" id="pan-stem-6"></span>
            </div>
            <div class="qimen-pan-row row-3">
              <span class="pan-door" id="pan-door-6"></span>
              <span class="pan-dipan" id="pan-dipan-6"></span>
            </div>
            <div class="pan-gong-label">乾六宫</div>
          </div>
        </div>
        <!-- 图例 -->
        <div class="qimen-legend">
          <div class="qimen-legend-title">图例说明</div>
          <div class="qimen-legend-grid">
            <div class="legend-cell" style="color:#e74c3c">暗干</div>
            <div class="legend-cell" style="color:#00695c">八神</div>
            <div class="legend-cell">空/马</div>
            <div class="legend-cell"></div>
            <div class="legend-cell" style="color:#1565c0">九星</div>
            <div class="legend-cell" style="color:#c2185b">带干</div>
            <div class="legend-cell"></div>
            <div class="legend-cell" style="color:#6a1b9a">八门</div>
            <div class="legend-cell" style="color:#2e7d32">地盘</div>
          </div>
          <div class="qimen-legend-items">
            <div class="legend-item"><div class="legend-color angan"></div><span>暗干</span></div>
            <div class="legend-item"><div class="legend-color shen"></div><span>八神</span></div>
            <div class="legend-item"><div class="legend-color star"></div><span>九星</span></div>
            <div class="legend-item"><div class="legend-color stem"></div><span>带干</span></div>
            <div class="legend-item"><div class="legend-color door"></div><span>八门</span></div>
            <div class="legend-item"><div class="legend-color dipan"></div><span>地盘</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 排盘过程详细信息 - 可折叠 -->
    <div class="collapsible-section" id="detailSection">
      <div class="collapsible-header" onclick="toggleDetailSection()">
        <span class="collapsible-icon">▶</span>
        <span class="collapsible-title">排盘过程详细信息</span>
      </div>
      <div class="collapsible-content">
        <div class="collapsible-inner">
          <div class="compact-modules-grid">
            <!-- 洛书九宫 -->
            <div class="compact-module compact-luoshu">
              <div class="compact-module-title">洛书九宫</div>
              <div class="compact-grid">
                <div class="compact-cell"><span class="luoshu-num">4</span><span class="luoshu-gua">巽</span></div>
                <div class="compact-cell"><span class="luoshu-num">9</span><span class="luoshu-gua">离</span></div>
                <div class="compact-cell"><span class="luoshu-num">2</span><span class="luoshu-gua">坤</span></div>
                <div class="compact-cell"><span class="luoshu-num">3</span><span class="luoshu-gua">震</span></div>
                <div class="compact-cell compact-center"><span class="luoshu-num">5</span><span class="luoshu-gua">中</span></div>
                <div class="compact-cell"><span class="luoshu-num">7</span><span class="luoshu-gua">兑</span></div>
                <div class="compact-cell"><span class="luoshu-num">8</span><span class="luoshu-gua">艮</span></div>
                <div class="compact-cell"><span class="luoshu-num">1</span><span class="luoshu-gua">坎</span></div>
                <div class="compact-cell"><span class="luoshu-num">6</span><span class="luoshu-gua">乾</span></div>
              </div>
            </div>

            <!-- 奇门地盘 -->
            <div class="compact-module compact-dipan">
              <div class="compact-module-title">奇门地盘</div>
              <div class="result-placeholder" id="dipanPlaceholder" style="font-size:11px;padding:10px;">请先计算局数</div>
              <div class="result-content" id="dipanContent">
                <div class="compact-info"><span id="dipanJuInfo"></span></div>
                <div class="compact-grid">
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-4"></span><span class="luoshu-gua">巽四</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-9"></span><span class="luoshu-gua">离九</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-2"></span><span class="luoshu-gua">坤二</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-3"></span><span class="luoshu-gua">震三</span></div>
                  <div class="compact-cell compact-center"><span class="dipan-stem" id="dipan-5"></span><span class="luoshu-gua">中五</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-7"></span><span class="luoshu-gua">兑七</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-8"></span><span class="luoshu-gua">艮八</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-1"></span><span class="luoshu-gua">坎一</span></div>
                  <div class="compact-cell"><span class="dipan-stem" id="dipan-6"></span><span class="luoshu-gua">乾六</span></div>
                </div>
              </div>
            </div>

            <!-- 奇门天盘（九星） -->
            <div class="compact-module compact-tianpan">
              <div class="compact-module-title">奇门天盘（九星）</div>
              <div class="result-placeholder" id="tianpanPlaceholder" style="font-size:11px;padding:10px;">请先计算局数</div>
              <div class="result-content" id="tianpanContent">
                <div class="compact-info">值符:<strong id="tianpanZhiFu"></strong> 落宫:<strong id="tianpanTarget"></strong></div>
                <div class="compact-grid">
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-4"></span><span class="luoshu-gua">巽四</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-9"></span><span class="luoshu-gua">离九</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-2"></span><span class="luoshu-gua">坤二</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-3"></span><span class="luoshu-gua">震三</span></div>
                  <div class="compact-cell compact-center"><span class="tianpan-star" id="tianpan-5"></span><span class="luoshu-gua">中五</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-7"></span><span class="luoshu-gua">兑七</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-8"></span><span class="luoshu-gua">艮八</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-1"></span><span class="luoshu-gua">坎一</span></div>
                  <div class="compact-cell"><span class="tianpan-star" id="tianpan-6"></span><span class="luoshu-gua">乾六</span></div>
                </div>
              </div>
            </div>

            <!-- 九星原始宫位干 -->
            <div class="compact-module compact-starstem">
              <div class="compact-module-title">九星原始宫位干</div>
              <div class="result-placeholder" id="starStemPlaceholder" style="font-size:11px;padding:10px;">请先计算局数</div>
              <div class="result-content" id="starStemContent">
                <div class="compact-info">九星对应原始宫位的地盘干</div>
                <div class="compact-grid">
                  <div class="compact-cell"><span class="starstem-star">天辅</span><span class="starstem-gan" id="starStem-4">--</span><span class="luoshu-gua">巽四</span></div>
                  <div class="compact-cell"><span class="starstem-star">天英</span><span class="starstem-gan" id="starStem-9">--</span><span class="luoshu-gua">离九</span></div>
                  <div class="compact-cell"><span class="starstem-star">天芮</span><span class="starstem-gan" id="starStem-2">--</span><span class="luoshu-gua">坤二</span></div>
                  <div class="compact-cell"><span class="starstem-star">天冲</span><span class="starstem-gan" id="starStem-3">--</span><span class="luoshu-gua">震三</span></div>
                  <div class="compact-cell compact-center"><span class="starstem-star">天禽</span><span class="starstem-gan" id="starStem-5">--</span><span class="luoshu-gua">中五</span></div>
                  <div class="compact-cell"><span class="starstem-star">天柱</span><span class="starstem-gan" id="starStem-7">--</span><span class="luoshu-gua">兑七</span></div>
                  <div class="compact-cell"><span class="starstem-star">天任</span><span class="starstem-gan" id="starStem-8">--</span><span class="luoshu-gua">艮八</span></div>
                  <div class="compact-cell"><span class="starstem-star">天蓬</span><span class="starstem-gan" id="starStem-1">--</span><span class="luoshu-gua">坎一</span></div>
                  <div class="compact-cell"><span class="starstem-star">天心</span><span class="starstem-gan" id="starStem-6">--</span><span class="luoshu-gua">乾六</span></div>
                </div>
              </div>
            </div>

            <!-- 八门原始宫位 -->
            <div class="compact-module compact-doororigin">
              <div class="compact-module-title">八门原始宫位</div>
              <div class="compact-grid">
                <div class="compact-cell"><span class="door-origin-name">杜门</span><span class="luoshu-gua">巽四</span></div>
                <div class="compact-cell"><span class="door-origin-name">景门</span><span class="luoshu-gua">离九</span></div>
                <div class="compact-cell"><span class="door-origin-name">死门</span><span class="luoshu-gua">坤二</span></div>
                <div class="compact-cell"><span class="door-origin-name">伤门</span><span class="luoshu-gua">震三</span></div>
                <div class="compact-cell compact-center"><span class="door-origin-name">--</span><span class="luoshu-gua">中五</span></div>
                <div class="compact-cell"><span class="door-origin-name">惊门</span><span class="luoshu-gua">兑七</span></div>
                <div class="compact-cell"><span class="door-origin-name">生门</span><span class="luoshu-gua">艮八</span></div>
                <div class="compact-cell"><span class="door-origin-name">休门</span><span class="luoshu-gua">坎一</span></div>
                <div class="compact-cell"><span class="door-origin-name">开门</span><span class="luoshu-gua">乾六</span></div>
              </div>
            </div>

            <!-- 奇门八门 -->
            <div class="compact-module compact-door">
              <div class="compact-module-title">奇门八门</div>
              <div class="result-placeholder" id="doorPlaceholder" style="font-size:11px;padding:10px;">请先计算局数</div>
              <div class="result-content" id="doorContent">
                <div class="compact-info">值使:<strong id="doorZhiShi"></strong> 落宫:<strong id="doorTarget"></strong></div>
                <div class="compact-grid">
                  <div class="compact-cell"><span class="door-name" id="door-4">--</span><span class="door-angan" id="angan-4"></span><span class="luoshu-gua">巽四</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-9">--</span><span class="door-angan" id="angan-9"></span><span class="luoshu-gua">离九</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-2">--</span><span class="door-angan" id="angan-2"></span><span class="luoshu-gua">坤二</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-3">--</span><span class="door-angan" id="angan-3"></span><span class="luoshu-gua">震三</span></div>
                  <div class="compact-cell compact-center"><span class="door-name" id="door-5">--</span><span class="door-angan" id="angan-5"></span><span class="luoshu-gua">中五</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-7">--</span><span class="door-angan" id="angan-7"></span><span class="luoshu-gua">兑七</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-8">--</span><span class="door-angan" id="angan-8"></span><span class="luoshu-gua">艮八</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-1">--</span><span class="door-angan" id="angan-1"></span><span class="luoshu-gua">坎一</span></div>
                  <div class="compact-cell"><span class="door-name" id="door-6">--</span><span class="door-angan" id="angan-6"></span><span class="luoshu-gua">乾六</span></div>
                </div>
              </div>
            </div>

            <!-- 奇门八神 -->
            <div class="compact-module compact-shen">
              <div class="compact-module-title">奇门八神</div>
              <div class="result-placeholder" id="shenPlaceholder" style="font-size:11px;padding:10px;">请先计算局数</div>
              <div class="result-content" id="shenContent">
                <div class="compact-info">值符落宫:<strong id="shenZhiFuPalace"></strong></div>
                <div class="compact-grid">
                  <div class="compact-cell"><span class="shen-name" id="shen-4">--</span><span class="luoshu-gua">巽四</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-9">--</span><span class="luoshu-gua">离九</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-2">--</span><span class="luoshu-gua">坤二</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-3">--</span><span class="luoshu-gua">震三</span></div>
                  <div class="compact-cell compact-center"><span class="shen-name" id="shen-5">--</span><span class="luoshu-gua">中五</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-7">--</span><span class="luoshu-gua">兑七</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-8">--</span><span class="luoshu-gua">艮八</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-1">--</span><span class="luoshu-gua">坎一</span></div>
                  <div class="compact-cell"><span class="shen-name" id="shen-6">--</span><span class="luoshu-gua">乾六</span></div>
                </div>
              </div>
            </div>

            <!-- 空亡马星 -->
            <div class="compact-module compact-kongwang">
              <div class="compact-module-title">空亡马星</div>
              <div class="result-placeholder" id="kongwangPlaceholder" style="font-size:11px;padding:10px;">请先计算局数</div>
              <div class="result-content" id="kongwangContent">
                <div class="compact-info">空亡:<strong id="kongwangBranches"></strong> 马星:<strong id="maxingBranch"></strong></div>
                <div class="compact-grid">
                  <div class="compact-cell" id="kongwang-cell-4"><div id="kongwang-4"></div><span class="luoshu-gua">巽四</span></div>
                  <div class="compact-cell" id="kongwang-cell-9"><div id="kongwang-9"></div><span class="luoshu-gua">离九</span></div>
                  <div class="compact-cell" id="kongwang-cell-2"><div id="kongwang-2"></div><span class="luoshu-gua">坤二</span></div>
                  <div class="compact-cell" id="kongwang-cell-3"><div id="kongwang-3"></div><span class="luoshu-gua">震三</span></div>
                  <div class="compact-cell compact-center" id="kongwang-cell-5"><div id="kongwang-5"></div><span class="luoshu-gua">中五</span></div>
                  <div class="compact-cell" id="kongwang-cell-7"><div id="kongwang-7"></div><span class="luoshu-gua">兑七</span></div>
                  <div class="compact-cell" id="kongwang-cell-8"><div id="kongwang-8"></div><span class="luoshu-gua">艮八</span></div>
                  <div class="compact-cell" id="kongwang-cell-1"><div id="kongwang-1"></div><span class="luoshu-gua">坎一</span></div>
                  <div class="compact-cell" id="kongwang-cell-6"><div id="kongwang-6"></div><span class="luoshu-gua">乾六</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 节气显示 -->
    <div class="card">
      <div class="card-title">节气信息</div>
      <div class="result-placeholder" id="jieqiPlaceholder">
        请设置时间后点击「开始计算」
      </div>
      <div class="result-content" id="jieqiContent">
        <div class="jieqi-item">
          <div><span class="jieqi-name" id="prevJieqiName"></span> <span class="jieqi-time" id="prevJieqiTime"></span></div>
          <div class="jieqi-distance">已过: <span id="prevJieqiDistance"></span></div>
        </div>
        <div class="jieqi-item">
          <div><span class="jieqi-name" id="nextJieqiName"></span> <span class="jieqi-time" id="nextJieqiTime"></span></div>
          <div class="jieqi-distance">还有: <span id="nextJieqiDistance"></span></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 折叠/展开详情板块
    function toggleDetailSection() {
      const section = document.getElementById('detailSection');
      section.classList.toggle('expanded');
    }

    // 城市数据
    const cities = [
      { name: "北京", lng: 116.4074, lat: 39.9042 },
      { name: "上海", lng: 121.4737, lat: 31.2304 },
      { name: "广州", lng: 113.2644, lat: 23.1291 },
      { name: "深圳", lng: 114.0579, lat: 22.5431 },
      { name: "成都", lng: 104.0665, lat: 30.5723 },
      { name: "重庆", lng: 106.5516, lat: 29.5630 },
      { name: "杭州", lng: 120.1551, lat: 30.2741 },
      { name: "南京", lng: 118.7969, lat: 32.0603 },
      { name: "武汉", lng: 114.3054, lat: 30.5931 },
      { name: "西安", lng: 108.9402, lat: 34.3416 },
      { name: "天津", lng: 117.1900, lat: 39.1256 },
      { name: "苏州", lng: 120.5853, lat: 31.2989 },
      { name: "郑州", lng: 113.6254, lat: 34.7466 },
      { name: "长沙", lng: 112.9388, lat: 28.2282 },
      { name: "东莞", lng: 113.7518, lat: 23.0207 },
      { name: "沈阳", lng: 123.4315, lat: 41.8057 },
      { name: "青岛", lng: 120.3826, lat: 36.0671 },
      { name: "合肥", lng: 117.2272, lat: 31.8206 },
      { name: "佛山", lng: 113.1214, lat: 23.0218 },
      { name: "宁波", lng: 121.5440, lat: 29.8683 },
      { name: "昆明", lng: 102.8329, lat: 24.8801 },
      { name: "大连", lng: 121.6147, lat: 38.9140 },
      { name: "福州", lng: 119.2965, lat: 26.0745 },
      { name: "厦门", lng: 118.0894, lat: 24.4798 },
      { name: "哈尔滨", lng: 126.5346, lat: 45.8038 },
      { name: "济南", lng: 117.1205, lat: 36.6510 },
      { name: "温州", lng: 120.6994, lat: 27.9938 },
      { name: "南宁", lng: 108.3661, lat: 22.8170 },
      { name: "长春", lng: 125.3235, lat: 43.8171 },
      { name: "石家庄", lng: 114.5149, lat: 38.0428 },
      { name: "太原", lng: 112.5489, lat: 37.8706 },
      { name: "贵阳", lng: 106.6302, lat: 26.6477 },
      { name: "南昌", lng: 115.8581, lat: 28.6820 },
      { name: "兰州", lng: 103.8343, lat: 36.0611 },
      { name: "海口", lng: 110.3119, lat: 20.0440 },
      { name: "呼和浩特", lng: 111.7490, lat: 40.8424 },
      { name: "乌鲁木齐", lng: 87.6168, lat: 43.8256 },
      { name: "拉萨", lng: 91.1409, lat: 29.6456 },
      { name: "西宁", lng: 101.7782, lat: 36.6171 },
      { name: "银川", lng: 106.2309, lat: 38.4872 },
      { name: "香港", lng: 114.1694, lat: 22.3193 },
      { name: "澳门", lng: 113.5439, lat: 22.1987 },
      { name: "台北", lng: 121.5654, lat: 25.0330 }
    ];

    // 奇门遁甲局数表
    const qimenJuTable = {
      '冬至': { '上元': '阳遁一局', '中元': '阳遁七局', '下元': '阳遁四局' },
      '小寒': { '上元': '阳遁二局', '中元': '阳遁八局', '下元': '阳遁五局' },
      '大寒': { '上元': '阳遁三局', '中元': '阳遁九局', '下元': '阳遁六局' },
      '立春': { '上元': '阳遁八局', '中元': '阳遁五局', '下元': '阳遁二局' },
      '雨水': { '上元': '阳遁九局', '中元': '阳遁六局', '下元': '阳遁三局' },
      '惊蛰': { '上元': '阳遁一局', '中元': '阳遁七局', '下元': '阳遁四局' },
      '春分': { '上元': '阳遁三局', '中元': '阳遁九局', '下元': '阳遁六局' },
      '清明': { '上元': '阳遁四局', '中元': '阳遁一局', '下元': '阳遁七局' },
      '谷雨': { '上元': '阳遁五局', '中元': '阳遁二局', '下元': '阳遁八局' },
      '立夏': { '上元': '阳遁四局', '中元': '阳遁一局', '下元': '阳遁七局' },
      '小满': { '上元': '阳遁五局', '中元': '阳遁二局', '下元': '阳遁八局' },
      '芒种': { '上元': '阳遁六局', '中元': '阳遁三局', '下元': '阳遁九局' },
      '夏至': { '上元': '阴遁九局', '中元': '阴遁三局', '下元': '阴遁六局' },
      '小暑': { '上元': '阴遁八局', '中元': '阴遁二局', '下元': '阴遁五局' },
      '大暑': { '上元': '阴遁七局', '中元': '阴遁一局', '下元': '阴遁四局' },
      '立秋': { '上元': '阴遁二局', '中元': '阴遁五局', '下元': '阴遁八局' },
      '处暑': { '上元': '阴遁一局', '中元': '阴遁四局', '下元': '阴遁七局' },
      '白露': { '上元': '阴遁九局', '中元': '阴遁三局', '下元': '阴遁六局' },
      '秋分': { '上元': '阴遁七局', '中元': '阴遁一局', '下元': '阴遁四局' },
      '寒露': { '上元': '阴遁六局', '中元': '阴遁九局', '下元': '阴遁三局' },
      '霜降': { '上元': '阴遁五局', '中元': '阴遁八局', '下元': '阴遁二局' },
      '立冬': { '上元': '阴遁六局', '中元': '阴遁九局', '下元': '阴遁三局' },
      '小雪': { '上元': '阴遁五局', '中元': '阴遁八局', '下元': '阴遁二局' },
      '大雪': { '上元': '阴遁四局', '中元': '阴遁七局', '下元': '阴遁一局' }
    };

    // 获取奇门局数
    function getQimenJu(jieqiName, sanYuan) {
      const jieqi = qimenJuTable[jieqiName];
      if (jieqi && jieqi[sanYuan]) {
        return jieqi[sanYuan];
      }
      return '--';
    }

    // 计算奇门地盘
    function calculateDiPan(juNumber, isYang) {
      // 三奇六仪固定序列
      const stems = ['戊', '己', '庚', '辛', '壬', '癸', '丁', '丙', '乙'];
      // 初始化九宫格 (1-9对应各宫)
      const palaces = {};
      for (let i = 1; i <= 9; i++) {
        palaces[i] = '';
      }

      for (let i = 0; i < 9; i++) {
        let pos;
        if (isYang) {
          // 阳遁: 顺布
          pos = (juNumber + i - 1) % 9 + 1;
        } else {
          // 阴遁: 逆布
          pos = (juNumber - i - 1) % 9 + 1;
          if (pos <= 0) pos += 9;
        }
        palaces[pos] = stems[i];
      }

      return palaces;
    }

    // 获取六仪在地盘的宫位
    function getDiPanPosition(palaces, stem) {
      for (let i = 1; i <= 9; i++) {
        if (palaces[i] === stem) return i;
      }
      return 1;
    }

    // 计算旬首、值符、值使
    function calculateLeaders(hourGan, hourZhi, juStr) {
      const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
      const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      // 1. 计算旬首偏移量 (地支索引 - 天干索引)
      const ganIndex = tianGan.indexOf(hourGan);
      const zhiIndex = diZhi.indexOf(hourZhi);
      let diff = zhiIndex - ganIndex;
      if (diff < 0) diff += 12;

      // 2. 确定旬首六仪
      const xunShouMap = {0: '戊', 10: '己', 8: '庚', 6: '辛', 4: '壬', 2: '癸'};
      const xunShouStem = xunShouMap[diff] || '戊';

      // 旬首名称
      const xunShouNames = {
        '戊': '甲子(戊)',
        '己': '甲戌(己)',
        '庚': '甲申(庚)',
        '辛': '甲午(辛)',
        '壬': '甲辰(壬)',
        '癸': '甲寅(癸)'
      };

      // 3. 计算地盘，找旬首六仪落宫
      const isYang = juStr.startsWith('阳');
      const juNumMap = {'一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9};
      const juChar = juStr.replace(/[阳阴遁局]/g, '');
      const juNumber = juNumMap[juChar] || 1;
      
      const palaces = calculateDiPan(juNumber, isYang);
      const startPalace = getDiPanPosition(palaces, xunShouStem);

      // 4. 确定值符（九星）
      const stars = {
        1: '天蓬', 2: '天芮', 3: '天冲', 4: '天辅', 5: '天禽',
        6: '天心', 7: '天柱', 8: '天任', 9: '天英'
      };
      const zhiFu = stars[startPalace];

      // 5. 确定值使（八门）
      const gates = {
        1: '休门', 2: '死门', 3: '伤门', 4: '杜门', 5: '死门',
        6: '开门', 7: '惊门', 8: '生门', 9: '景门'
      };
      const zhiShi = gates[startPalace];

      return {
        xunShou: xunShouNames[xunShouStem],
        xunShouStem: xunShouStem,
        zhiFu: zhiFu,
        zhiShi: zhiShi,
        startPalace: startPalace
      };
    }

    // 计算天盘（九星）
    function calculateHeavenPlate(hourGan, hourZhi, juStr) {
      const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
      const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      // 九星顺时针序列 (按洛书数: 1, 8, 3, 4, 9, 2, 7, 6)
      const starsSequence = ['天蓬', '天任', '天冲', '天辅', '天英', '天芮', '天柱', '天心'];
      
      // 九星原始宫位
      const originalPalace = {
        '天蓬': 1, '天任': 8, '天冲': 3, '天辅': 4,
        '天英': 9, '天芮': 2, '天柱': 7, '天心': 6
      };
      
      // 宫位顺时针序列
      const palaceSequence = [1, 8, 3, 4, 9, 2, 7, 6];
      
      // 计算地盘
      const isYang = juStr.startsWith('阳');
      const juNumMap = {'一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9};
      const juChar = juStr.replace(/[阳阴遁局]/g, '');
      const juNumber = juNumMap[juChar] || 1;
      const earthPalaces = calculateDiPan(juNumber, isYang);
      
      // 找旬首六仪
      const ganIndex = tianGan.indexOf(hourGan);
      const zhiIndex = diZhi.indexOf(hourZhi);
      let diff = zhiIndex - ganIndex;
      if (diff < 0) diff += 12;
      const xunShouMap = {0: '戊', 10: '己', 8: '庚', 6: '辛', 4: '壬', 2: '癸'};
      const leaderStem = xunShouMap[diff] || '戊';
      
      // 找旬首六仪在地盘的落宫
      let leaderPalaceIndex = getDiPanPosition(earthPalaces, leaderStem);
      const originalLeaderPalace = leaderPalaceIndex; // 保存原始宫位
      
      // 中5宫寄坤2宫
      let isLeaderIn5 = false;
      if (leaderPalaceIndex === 5) {
        isLeaderIn5 = true;
        leaderPalaceIndex = 2;
      }
      
      // 根据宫位找值符星
      // 特殊处理：如果旬首落在中5宫，值符星视为天禽/天芮
      const palaceToStar = {};
      for (const [star, palace] of Object.entries(originalPalace)) {
        palaceToStar[palace] = star;
      }
      let zhiFuStar;
      if (isLeaderIn5) {
        zhiFuStar = '天禽'; // 旬首落中5宫，值符为天禽（与天芮同宫）
      } else {
        zhiFuStar = palaceToStar[leaderPalaceIndex] || '天蓬';
      }
      
      // 找目标落宫（值符随时干）
      let targetStem = hourGan;
      if (hourGan === '甲') {
        targetStem = leaderStem; // 甲时以旬首为准
      }
      
      let targetPalaceIndex = getDiPanPosition(earthPalaces, targetStem);
      
      // 目标位中5宫寄坤2
      if (targetPalaceIndex === 5) {
        targetPalaceIndex = 2;
      }
      
      // 排布天盘
      const resultHeavenPlate = {};
      const heavenPlateStems = {}; // 九星带干（天盘干）
      
      // 找值符在序列中的索引
      // 特殊处理：天禽与天芮同宫，用天芮的索引
      let startSeqIdx;
      if (zhiFuStar === '天禽') {
        startSeqIdx = starsSequence.indexOf('天芮'); // 天禽跟随天芮
      } else {
        startSeqIdx = starsSequence.indexOf(zhiFuStar);
      }
      
      // 找目标宫位在序列中的索引
      const targetPalaceSeqIdx = palaceSequence.indexOf(targetPalaceIndex);
      
      // 计算偏移量：TargetPos - OriginalPos（在九宫循环序列中的偏移）
      const zhifuOrigPalaceIdx = palaceSequence.indexOf(leaderPalaceIndex);
      const offset = targetPalaceSeqIdx - zhifuOrigPalaceIdx;
      
      // 循环填充九星
      let tianRuiPalace = null;
      for (let i = 0; i < 8; i++) {
        const currentStar = starsSequence[(startSeqIdx + i) % 8];
        const currentPalace = palaceSequence[(targetPalaceSeqIdx + i) % 8];
        resultHeavenPlate[currentPalace] = currentStar;
        
        // 记录天芮所在宫位
        if (currentStar === '天芮') {
          tianRuiPalace = currentPalace;
        }
      }
      
      // 计算天盘干（九星带干）
      // 逻辑：每个星 S 的原始宫位为 P_old，S 携带的干 = EarthPlate[P_old]
      // S 移动到新宫位 P_new = P_old + Offset（在九宫循环序列中）
      // 最终 P_new 宫位的天盘干 = EarthPlate[P_old]
      for (let i = 0; i < 8; i++) {
        const origPalace = palaceSequence[i]; // 星的原始宫位 P_old
        const newPalaceIdx = (i + offset % 8 + 8) % 8; // 新宫位在序列中的索引
        const newPalace = palaceSequence[newPalaceIdx]; // 星的新宫位 P_new
        const stemCarried = earthPalaces[origPalace]; // 该星携带的干 = 地盘[P_old]
        
        // 特殊处理：原始宫位是2（天芮），同时带坤2和中5的干（天禽）
        if (origPalace === 2) {
          const stemGuest = earthPalaces[5]; // 中宫之干（天禽带的干）
          heavenPlateStems[newPalace] = [stemCarried, stemGuest];
        } else {
          if (!heavenPlateStems[newPalace]) {
            heavenPlateStems[newPalace] = [stemCarried];
          }
        }
      }
      
      // 天禽随天芮，显示在同一宫位
      if (tianRuiPalace) {
        resultHeavenPlate[tianRuiPalace] = '天芮/天禽';
      }
      
      // 中5宫不显示九星
      resultHeavenPlate[5] = '';
      heavenPlateStems[5] = [];
      
      return {
        plate: resultHeavenPlate,
        stems: heavenPlateStems,
        zhiFuStar: zhiFuStar,
        targetPalace: targetPalaceIndex
      };
    }

    // 计算八门落宫
    function calculateDoorPositions(hourGan, hourZhi, juStr) {
      const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
      const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      // 顺时针宫位环
      const palaceRing = [1, 8, 3, 4, 9, 2, 7, 6];
      // 八门序列（对应宫位原始位置）
      const doorsSequence = ['休', '生', '伤', '杜', '景', '死', '惊', '开'];
      // 八门原始宫位
      const doorOriginalPalace = {
        '休': 1, '生': 8, '伤': 3, '杜': 4,
        '景': 9, '死': 2, '惊': 7, '开': 6
      };
      
      // 计算局数和阴阳遁
      const isYang = juStr.startsWith('阳');
      const juNumMap = {'一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9};
      const juChar = juStr.replace(/[阳阴遁局]/g, '');
      const juNumber = juNumMap[juChar] || 1;
      
      // 计算地盘
      const earthPalaces = calculateDiPan(juNumber, isYang);
      
      // 计算旬首六仪
      const ganIndex = tianGan.indexOf(hourGan);
      const zhiIndex = diZhi.indexOf(hourZhi);
      let diff = zhiIndex - ganIndex;
      if (diff < 0) diff += 12;
      const xunShouMap = {0: '戊', 10: '己', 8: '庚', 6: '辛', 4: '壬', 2: '癸'};
      const xunShouStem = xunShouMap[diff] || '戊';
      
      // 找旬首六仪落宫（这是直使门的起点）
      const xunShouLoc = getDiPanPosition(earthPalaces, xunShouStem);
      
      // 确定值使门（根据旬首落宫对应的原始门）
      const gatesMap = {
        1: '休', 2: '死', 3: '伤', 4: '杜', 5: '死',
        6: '开', 7: '惊', 8: '生', 9: '景'
      };
      const zhiShi = gatesMap[xunShouLoc];
      
      // 计算时辰偏移量
      // 偏移量 = 当前时支序号 - 旬首时支序号
      const xunShouZhiMap = {'戊': 0, '己': 10, '庚': 8, '辛': 6, '壬': 4, '癸': 2};
      const xunShouZhiIdx = xunShouZhiMap[xunShouStem];
      let hourOffset = zhiIndex - xunShouZhiIdx;
      if (hourOffset < 0) hourOffset += 12;
      
      // 计算直使门落宫
      // 阳遁：顺着洛书九宫数飞动（1→2→3→4→5→6→7→8→9）
      // 阴遁：逆着洛书九宫数飞动（9→8→7→6→5→4→3→2→1）
      // 起点是旬首落宫（即使是5宫也从5开始计算，不是先寄到2）
      let startPalace = xunShouLoc;
      
      let currentLoc;
      if (isYang) {
        // 阳遁落宫 = 旬首宫位 + 偏移量
        currentLoc = startPalace + hourOffset;
        // 处理超过9的情况
        while (currentLoc > 9) {
          currentLoc -= 9;
        }
      } else {
        // 阴遁落宫 = 旬首宫位 - 偏移量
        currentLoc = startPalace - hourOffset;
        // 处理小于1的情况
        while (currentLoc < 1) {
          currentLoc += 9;
        }
      }
      
      // 中宫处理：只有最终结果是5时，才寄到2
      const zhiShiTargetPalace = currentLoc === 5 ? 2 : currentLoc;
      
      // 排布八门
      // 八门顺序固定：休、生、伤、杜、景、死、惊、开
      // 从值使落宫开始，阳遁顺时针、阴遁逆时针排布
      const resultLayout = {};
      
      // 九宫顺时针路径
      const clockwisePath = [1, 8, 3, 4, 9, 2, 7, 6];
      // 九宫逆时针路径
      const counterClockwisePath = [1, 6, 7, 2, 9, 4, 3, 8];
      
      // 根据阴阳遁选择路径
      const palacePath = isYang ? clockwisePath : counterClockwisePath;
      
      // 找到直使门在门序列中的索引
      const doorIdx = doorsSequence.indexOf(zhiShi);
      // 找到值使落宫在路径中的索引
      const startIdx = palacePath.indexOf(zhiShiTargetPalace);
      
      // 循环填充8次
      for (let i = 0; i < 8; i++) {
        const currDoor = doorsSequence[(doorIdx + i) % 8];
        const currPalace = palacePath[(startIdx + i) % 8];
        resultLayout[currPalace] = currDoor + '门';
      }
      
      // 中5宫无门
      resultLayout[5] = '';
      
      // 计算暗干
      const anGan = calculateAnGan(currentLoc, hourGan, isYang, xunShouStem);
      
      return {
        layout: resultLayout,
        anGan: anGan,
        zhiShi: zhiShi + '门',
        targetPalace: zhiShiTargetPalace
      };
    }

    // 计算暗干
    function calculateAnGan(zhiShiPalace, hourStem, isYang, leaderStem) {
      // 标准奇门天干环（六仪三奇顺序）
      const stemRing = ['戊', '己', '庚', '辛', '壬', '癸', '丁', '丙', '乙'];
      
      // 处理时干为甲的情况（甲时隐于旬首）
      const actualStem = hourStem === '甲' ? leaderStem : hourStem;
      
      // 找到起始天干在环中的索引
      let currentStemIdx = stemRing.indexOf(actualStem);
      if (currentStemIdx === -1) {
        currentStemIdx = 0; // 默认戊
      }
      
      // 初始化结果容器
      const anGanResult = {};
      
      // 开始排布（遍历9次）
      let currentPalace = zhiShiPalace;
      
      for (let i = 0; i < 9; i++) {
        // 记录当前宫位的暗干
        anGanResult[currentPalace] = stemRing[currentStemIdx];
        
        // 天干指针永远+1（顺排）
        currentStemIdx = (currentStemIdx + 1) % 9;
        
        // 宫位指针根据阴阳遁移动
        if (isYang) {
          // 阳遁，宫位顺行（1→2→...→9→1）
          currentPalace += 1;
          if (currentPalace > 9) {
            currentPalace = 1;
          }
        } else {
          // 阴遁，宫位逆行（9→8→...→1→9）
          currentPalace -= 1;
          if (currentPalace < 1) {
            currentPalace = 9;
          }
        }
      }
      
      return anGanResult;
    }

    // 计算八神排布
    function calculateBaShen(isYang, zhiFuLocation) {
      // 八神固定序列
      const deitiesList = ['值符', '螣蛇', '太阴', '六合', '白虎', '玄武', '九地', '九天'];
      
      // 九宫圆周顺序（跳过中宫5）
      const palaceRing = [1, 8, 3, 4, 9, 2, 7, 6];
      
      // 如果值符落在中5宫，寄到坤2宫
      let startPalace = zhiFuLocation;
      if (startPalace === 5) {
        startPalace = 2;
      }
      
      // 找到值符在圆周数组中的起始索引
      const startIndex = palaceRing.indexOf(startPalace);
      if (startIndex === -1) {
        return {};
      }
      
      // 根据阴阳遁排布
      const resultMap = {};
      
      if (isYang) {
        // 阳遁：顺时针
        for (let i = 0; i < 8; i++) {
          const currentPalaceIndex = (startIndex + i) % 8;
          const palaceNum = palaceRing[currentPalaceIndex];
          resultMap[palaceNum] = deitiesList[i];
        }
      } else {
        // 阴遁：逆时针
        for (let i = 0; i < 8; i++) {
          const currentPalaceIndex = ((startIndex - i) % 8 + 8) % 8;
          const palaceNum = palaceRing[currentPalaceIndex];
          resultMap[palaceNum] = deitiesList[i];
        }
      }
      
      // 中5宫无神
      resultMap[5] = '';
      
      return resultMap;
    }

    // 更新八神显示
    function updateBaShenDisplay(isYang, zhiFuLocation) {
      const shenLayout = calculateBaShen(isYang, zhiFuLocation);
      
      // 更新九宫格显示
      for (let i = 1; i <= 9; i++) {
        const el = document.getElementById('shen-' + i);
        if (el) {
          el.textContent = shenLayout[i] || '';
        }
      }
      
      // 显示值符落宫信息
      const gongNames = {1: '坎一宫', 2: '坤二宫', 3: '震三宫', 4: '巽四宫', 5: '中五宫', 6: '乾六宫', 7: '兑七宫', 8: '艮八宫', 9: '离九宫'};
      document.getElementById('shenZhiFuPalace').textContent = gongNames[zhiFuLocation];
      
      // 显示八神区域
      document.getElementById('shenPlaceholder').style.display = 'none';
      document.getElementById('shenContent').classList.add('show');
    }

    // 地支到宫位映射
    function getPalaceByBranch(branchIdx) {
      // 子->坎1, 丑寅->艮8, 卯->震3, 辰巳->巽4, 午->离9, 未申->坤2, 酉->兑7, 戌亥->乾6
      const mapping = {
        0: 1,       // 子 -> 坎
        1: 8, 2: 8, // 丑寅 -> 艮
        3: 3,       // 卯 -> 震
        4: 4, 5: 4, // 辰巳 -> 巽
        6: 9,       // 午 -> 离
        7: 2, 8: 2, // 未申 -> 坤
        9: 7,       // 酉 -> 兑
        10: 6, 11: 6 // 戌亥 -> 乾
      };
      return mapping[branchIdx] || 0;
    }

    // 计算空亡和马星
    function calculateKongWangMaXing(stemIdx, branchIdx) {
      const branches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      // 计算空亡地支（旬首推导）
      const leader = (branchIdx - stemIdx + 12) % 12;
      const voidIdx1 = (leader - 2 + 12) % 12;
      const voidIdx2 = (leader - 1 + 12) % 12;
      
      // 计算马星地支（三合局推导）
      // 申子辰(8,0,4)->寅(2); 寅午戌(2,6,10)->申(8); 
      // 巳酉丑(5,9,1)->亥(11); 亥卯未(11,3,7)->巳(5)
      const triadMap = {
        8: 2, 0: 2, 4: 2,    // 水局马在寅
        2: 8, 6: 8, 10: 8,   // 火局马在申
        5: 11, 9: 11, 1: 11, // 金局马在亥
        11: 5, 3: 5, 7: 5    // 木局马在巳
      };
      const maXingIdx = triadMap[branchIdx];
      
      // 映射到宫位
      const voidPalaces = [...new Set([getPalaceByBranch(voidIdx1), getPalaceByBranch(voidIdx2)])];
      const maXingPalace = getPalaceByBranch(maXingIdx);
      
      return {
        voidBranches: [branches[voidIdx1], branches[voidIdx2]],
        voidPalaces: voidPalaces,
        maXingBranch: branches[maXingIdx],
        maXingPalace: maXingPalace
      };
    }

    // 更新空亡马星显示
    function updateKongWangMaXingDisplay(hourGan, hourZhi) {
      const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
      const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      const stemIdx = tianGan.indexOf(hourGan);
      const branchIdx = diZhi.indexOf(hourZhi);
      
      const result = calculateKongWangMaXing(stemIdx, branchIdx);
      
      // 更新显示信息
      document.getElementById('kongwangBranches').textContent = result.voidBranches.join('、') + ' (' + result.voidPalaces.map(p => p + '宫').join('、') + ')';
      document.getElementById('maxingBranch').textContent = result.maXingBranch + ' (' + result.maXingPalace + '宫)';
      
      // 清除所有宫位的标记
      for (let i = 1; i <= 9; i++) {
        const cellEl = document.getElementById('kongwang-cell-' + i);
        const contentEl = document.getElementById('kongwang-' + i);
        if (cellEl) {
          cellEl.classList.remove('has-kong', 'has-ma', 'has-both');
        }
        if (contentEl) {
          contentEl.innerHTML = '';
        }
      }
      
      // 标记空亡宫位
      const kongPalaces = result.voidPalaces;
      const maPalace = result.maXingPalace;
      
      // 检查是否有重叠
      const hasBoth = kongPalaces.includes(maPalace);
      
      for (let i = 1; i <= 9; i++) {
        const cellEl = document.getElementById('kongwang-cell-' + i);
        const contentEl = document.getElementById('kongwang-' + i);
        if (!cellEl || !contentEl) continue;
        
        const isKong = kongPalaces.includes(i);
        const isMa = maPalace === i;
        
        let badges = '';
        if (isKong && isMa) {
          cellEl.classList.add('has-both');
          badges = '<span class="kong-badge">空</span><span class="ma-badge">马</span>';
        } else if (isKong) {
          cellEl.classList.add('has-kong');
          badges = '<span class="kong-badge">空</span>';
        } else if (isMa) {
          cellEl.classList.add('has-ma');
          badges = '<span class="ma-badge">马</span>';
        }
        contentEl.innerHTML = badges;
      }
      
      // 显示空亡马星区域
      document.getElementById('kongwangPlaceholder').style.display = 'none';
      document.getElementById('kongwangContent').classList.add('show');
    }

    // 更新综合奇门盘显示
    function updateQimenPanDisplay(hourGan, hourZhi, juStr) {
      const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
      const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      const isYang = juStr.startsWith('阳');
      const juNumMap = {'一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9};
      const juChar = juStr.replace(/[阳阴遁局]/g, '');
      const juNumber = juNumMap[juChar] || 1;
      
      // 计算所有数据
      const diPan = calculateDiPan(juNumber, isYang);
      const tianPanResult = calculateHeavenPlate(hourGan, hourZhi, juStr);
      const doorResult = calculateDoorPositions(hourGan, hourZhi, juStr);
      
      // 计算八神
      const shenLayout = calculateBaShen(isYang, tianPanResult.targetPalace);
      
      // 计算空亡马星
      const stemIdx = tianGan.indexOf(hourGan);
      const branchIdx = diZhi.indexOf(hourZhi);
      const kongMaResult = calculateKongWangMaXing(stemIdx, branchIdx);
      
      // 更新各宫位
      for (let i = 1; i <= 9; i++) {
        // 暗干
        const anganEl = document.getElementById('pan-angan-' + i);
        if (anganEl) {
          anganEl.textContent = doorResult.anGan[i] || '';
        }
        
        // 八神
        const shenEl = document.getElementById('pan-shen-' + i);
        if (shenEl) {
          shenEl.textContent = shenLayout[i] || '';
        }
        
        // 空亡马星标记
        const markersEl = document.getElementById('pan-markers-' + i);
        if (markersEl) {
          let badges = '';
          const isKong = kongMaResult.voidPalaces.includes(i);
          const isMa = kongMaResult.maXingPalace === i;
          if (isKong) {
            badges += '<span class="kong-badge">空</span>';
          }
          if (isMa) {
            badges += '<span class="ma-badge">马</span>';
          }
          markersEl.innerHTML = badges;
        }
        
        // 九星
        const starEl = document.getElementById('pan-star-' + i);
        if (starEl) {
          starEl.textContent = tianPanResult.plate[i] || '';
        }
        
        // 九星带干
        const stemEl = document.getElementById('pan-stem-' + i);
        if (stemEl) {
          const stemArr = tianPanResult.stems[i] || [];
          stemEl.textContent = stemArr.join('/');
        }
        
        // 八门
        const doorEl = document.getElementById('pan-door-' + i);
        if (doorEl) {
          doorEl.textContent = doorResult.layout[i] || '';
        }
        
        // 地盘
        const dipanEl = document.getElementById('pan-dipan-' + i);
        if (dipanEl) {
          dipanEl.textContent = diPan[i] || '';
        }
      }
      
      // 显示综合盘区域
      document.getElementById('qimenPanPlaceholder').style.display = 'none';
      document.getElementById('qimenPanContent').classList.add('show');
    }

    // 更新八门显示
    function updateDoorDisplay(hourGan, hourZhi, juStr) {
      if (!hourGan || !hourZhi) return;
      
      const result = calculateDoorPositions(hourGan, hourZhi, juStr);
      const layout = result.layout;
      const anGan = result.anGan;
      
      // 更新九宫格显示（八门+暗干）
      for (let i = 1; i <= 9; i++) {
        const doorEl = document.getElementById('door-' + i);
        const anganEl = document.getElementById('angan-' + i);
        if (doorEl) {
          doorEl.textContent = layout[i] || '';
        }
        if (anganEl) {
          anganEl.textContent = anGan[i] ? '暗' + anGan[i] : '';
        }
      }
      
      // 显示值使和落宫信息
      const gongNames = {1: '坎一宫', 2: '坤二宫', 3: '震三宫', 4: '巽四宫', 5: '中五宫', 6: '乾六宫', 7: '兑七宫', 8: '艮八宫', 9: '离九宫'};
      document.getElementById('doorZhiShi').textContent = result.zhiShi;
      document.getElementById('doorTarget').textContent = gongNames[result.targetPalace];
      
      // 显示八门区域
      document.getElementById('doorPlaceholder').style.display = 'none';
      document.getElementById('doorContent').classList.add('show');
    }

    // 更新天盘显示
    function updateHeavenPlate(hourGan, hourZhi, juStr) {
      if (!hourGan || !hourZhi) return null;
      
      const result = calculateHeavenPlate(hourGan, hourZhi, juStr);
      const plate = result.plate;
      const stems = result.stems;
      
      // 更新九宫格显示（九星+带干）
      for (let i = 1; i <= 9; i++) {
        const el = document.getElementById('tianpan-' + i);
        if (el) {
          const star = plate[i] || '';
          const stemArr = stems[i] || [];
          if (star && stemArr.length > 0) {
            // 显示格式：九星 + 带干
            const stemText = stemArr.join('/');
            el.innerHTML = `<span class="star-name">${star}</span><span class="star-stem">${stemText}</span>`;
          } else {
            el.textContent = star;
          }
        }
      }
      
      // 显示值符和落宫信息
      const gongNames = {1: '坎一宫', 2: '坤二宫', 3: '震三宫', 4: '巽四宫', 5: '中五宫', 6: '乾六宫', 7: '兑七宫', 8: '艮八宫', 9: '离九宫'};
      document.getElementById('tianpanZhiFu').textContent = result.zhiFuStar;
      document.getElementById('tianpanTarget').textContent = gongNames[result.targetPalace];
      
      // 显示天盘区域
      document.getElementById('tianpanPlaceholder').style.display = 'none';
      document.getElementById('tianpanContent').classList.add('show');
      
      return result;
    }

    // 更新地盘显示
    function updateDiPan(juStr, hourGan, hourZhi) {
      const isYang = juStr.startsWith('阳');
      const juNumMap = {'一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9};
      const juChar = juStr.replace(/[阳阴遁局]/g, '');
      const juNumber = juNumMap[juChar] || 1;

      const palaces = calculateDiPan(juNumber, isYang);

      // 更新九宫格显示
      for (let i = 1; i <= 9; i++) {
        document.getElementById('dipan-' + i).textContent = palaces[i];
      }

      // 显示局数信息
      document.getElementById('dipanJuInfo').textContent = juStr + ' · ' + (isYang ? '顺布六仪' : '逆布六仪');
      
      // 显示地盘区域
      document.getElementById('dipanPlaceholder').style.display = 'none';
      document.getElementById('dipanContent').classList.add('show');

      // 更新九星原始宫位干
      updateStarStems(palaces);

      // 更新值符值使（如果有时干支信息）
      if (hourGan && hourZhi) {
        const leaders = calculateLeaders(hourGan, hourZhi, juStr);
        document.getElementById('xunShouValue').textContent = leaders.xunShou;
        document.getElementById('zhiFuValue').textContent = leaders.zhiFu;
        document.getElementById('zhiShiValue').textContent = leaders.zhiShi;
        
        // 更新天盘
        const tianpanResult = updateHeavenPlate(hourGan, hourZhi, juStr);
        
        // 更新八门
        updateDoorDisplay(hourGan, hourZhi, juStr);
        
        // 更新八神（值符落宫 = 天盘值符星落宫）
        if (tianpanResult && tianpanResult.targetPalace) {
          updateBaShenDisplay(isYang, tianpanResult.targetPalace);
        }
        
        // 更新空亡马星
        updateKongWangMaXingDisplay(hourGan, hourZhi);
        
        // 更新综合奇门盘
        updateQimenPanDisplay(hourGan, hourZhi, juStr);
      }
    }

    // 更新九星原始宫位干显示
    function updateStarStems(palaces) {
      // 九星与原始宫位对应：天蓬-1, 天芮-2, 天冲-3, 天辅-4, 天禽-5, 天心-6, 天柱-7, 天任-8, 天英-9
      for (let i = 1; i <= 9; i++) {
        const el = document.getElementById('starStem-' + i);
        if (el) {
          el.textContent = palaces[i] || '--';
        }
      }
      
      // 显示九星原始宫位干区域
      document.getElementById('starStemPlaceholder').style.display = 'none';
      document.getElementById('starStemContent').classList.add('show');
    }

    // 当前时干支（用于手动调整时计算值符值使）
    let currentHourGan = null;
    let currentHourZhi = null;

    // 当前选择的经纬度
    let currentLng = null;
    let currentLat = null;

    // DOM 元素
    const dateInput = document.getElementById('dateInput');
    const timeInput = document.getElementById('timeInput');
    const nowBtn = document.getElementById('nowBtn');
    const citySelect = document.getElementById('citySelect');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const lngDisplay = document.getElementById('lngDisplay');
    const latDisplay = document.getElementById('latDisplay');
    const useTrueSolarTime = document.getElementById('useTrueSolarTime');
    const calculateBtn = document.getElementById('calculateBtn');
    const locationRadios = document.querySelectorAll('input[name="locationType"]');

    // 初始化城市下拉框
    function initCitySelect() {
      cities.forEach(city => {
        const option = document.createElement('option');
        option.value = JSON.stringify({ lng: city.lng, lat: city.lat });
        option.textContent = city.name;
        citySelect.appendChild(option);
      });
    }

    // 设置当前时间
    function setCurrentTime() {
      const now = new Date();
      dateInput.value = now.toISOString().split('T')[0];
      timeInput.value = now.toTimeString().slice(0, 5);
    }

    // 更新经纬度显示
    function updateCoordDisplay(lng, lat) {
      currentLng = lng;
      currentLat = lat;
      lngDisplay.textContent = lng !== null ? lng.toFixed(4) : '--';
      latDisplay.textContent = lat !== null ? lat.toFixed(4) : '--';
    }

    // 城市选择变化
    citySelect.addEventListener('change', function() {
      if (this.value) {
        const coords = JSON.parse(this.value);
        updateCoordDisplay(coords.lng, coords.lat);
      } else {
        updateCoordDisplay(null, null);
      }
    });

    // 位置类型切换
    locationRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        if (this.value === 'city') {
          citySelect.classList.remove('hidden');
          getLocationBtn.classList.add('hidden');
          // 清空经纬度
          updateCoordDisplay(null, null);
          citySelect.value = '';
        } else {
          citySelect.classList.add('hidden');
          getLocationBtn.classList.remove('hidden');
          // 清空经纬度
          updateCoordDisplay(null, null);
        }
      });
    });

    // 获取当前位置
    getLocationBtn.addEventListener('click', function() {
      if (!navigator.geolocation) {
        alert('您的浏览器不支持地理定位功能');
        return;
      }

      this.textContent = '获取中...';
      this.disabled = true;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          updateCoordDisplay(position.coords.longitude, position.coords.latitude);
          this.textContent = '获取位置';
          this.disabled = false;
        },
        (error) => {
          let msg = '无法获取位置';
          if (error.code === 1) msg = '您拒绝了位置权限，请手动选择城市';
          else if (error.code === 2) msg = '无法确定位置，请手动选择城市';
          else if (error.code === 3) msg = '获取位置超时，请重试或手动选择城市';
          alert(msg);
          this.textContent = '获取位置';
          this.disabled = false;
        },
        { timeout: 15000, enableHighAccuracy: false, maximumAge: 300000 }
      );
    });

    // 当前时刻按钮
    nowBtn.addEventListener('click', setCurrentTime);

    // 计算真太阳时
    function getTrueSolarTime(date, lat, lng) {
      const times = SunCalc.getTimes(date, lat, lng);
      const solarNoon = times.solarNoon;
      
      // 计算正午偏移（分钟）
      const noonMinutes = solarNoon.getHours() * 60 + solarNoon.getMinutes() + solarNoon.getSeconds() / 60;
      const noonOffset = noonMinutes - 12 * 60; // 与12:00的差值
      
      // 真太阳时 = 当前时间 - 偏移量
      const trueSolarTime = new Date(date.getTime() - noonOffset * 60 * 1000);
      return trueSolarTime;
    }

    // 计算符头
    function getFuTou(dayGan, dayZhi) {
      const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
      const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
      
      let ganIndex = tianGan.indexOf(dayGan);
      let zhiIndex = diZhi.indexOf(dayZhi);
      
      // 往前推，直到找到天干为"甲"或"己"
      while (ganIndex !== 0 && ganIndex !== 5) {
        ganIndex = (ganIndex - 1 + 10) % 10;
        zhiIndex = (zhiIndex - 1 + 12) % 12;
      }
      
      return {
        gan: tianGan[ganIndex],
        zhi: diZhi[zhiIndex],
        ganZhi: tianGan[ganIndex] + diZhi[zhiIndex]
      };
    }

    // 计算三元
    function getSanYuan(fuTouZhi) {
      const shangYuan = ['子', '午', '卯', '酉'];
      const zhongYuan = ['寅', '申', '巳', '亥'];
      const xiaYuan = ['辰', '戌', '丑', '未'];
      
      if (shangYuan.includes(fuTouZhi)) return '上元';
      if (zhongYuan.includes(fuTouZhi)) return '中元';
      if (xiaYuan.includes(fuTouZhi)) return '下元';
      return '';
    }

    // 计算节气距离
    function getJieQiDistance(currentTime, jieQiTime) {
      const diff = Math.abs(currentTime - jieQiTime);
      const totalMinutes = Math.floor(diff / (1000 * 60));
      const days = Math.floor(totalMinutes / (60 * 24));
      const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
      const minutes = totalMinutes % 60;
      
      return `${days}天${hours}小时${minutes}分钟`;
    }

    // 格式化日期时间
    function formatDateTime(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hour = String(date.getHours()).padStart(2, '0');
      const minute = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hour}:${minute}`;
    }

    // 渲染干支（带颜色）
    function renderGanZhi(gan, zhi) {
      return `<span class="gan">${gan}</span><span class="zhi">${zhi}</span>`;
    }

    // 开始计算
    calculateBtn.addEventListener('click', function() {
      // 验证输入
      if (!dateInput.value || !timeInput.value) {
        alert('请选择日期和时间');
        return;
      }

      if (currentLng === null || currentLat === null) {
        alert('请选择城市或获取当前位置');
        return;
      }

      // 解析时间
      const [year, month, day] = dateInput.value.split('-').map(Number);
      const [hour, minute] = timeInput.value.split(':').map(Number);
      const inputDate = new Date(year, month - 1, day, hour, minute);

      // 计算用的时间（可能是真太阳时）
      let calcDate = inputDate;
      const useTrueSolar = useTrueSolarTime.checked;

      if (useTrueSolar) {
        calcDate = getTrueSolarTime(inputDate, currentLat, currentLng);
      }

      // 使用 lunar-javascript 计算
      const calcHour = calcDate.getHours();
      const calcMinute = calcDate.getMinutes();
      
      // 处理子时换日规则：23:00-24:00 用当天日干，00:00-01:00 用次日日干
      // lunar-javascript 的 Solar.fromYmdHms 会处理时辰
      const solar = Solar.fromYmdHms(
        calcDate.getFullYear(),
        calcDate.getMonth() + 1,
        calcDate.getDate(),
        calcHour,
        calcMinute,
        0
      );
      const lunar = solar.getLunar();

      // 获取干支八字
      const eightChar = lunar.getEightChar();
      
      // 年柱
      const yearGan = eightChar.getYearGan();
      const yearZhi = eightChar.getYearZhi();
      
      // 月柱
      const monthGan = eightChar.getMonthGan();
      const monthZhi = eightChar.getMonthZhi();
      
      // 日柱
      const dayGan = eightChar.getDayGan();
      const dayZhi = eightChar.getDayZhi();
      
      // 时柱
      const hourGan = eightChar.getTimeGan();
      const hourZhi = eightChar.getTimeZhi();

      // 计算符头和三元
      const fuTou = getFuTou(dayGan, dayZhi);
      const sanYuan = getSanYuan(fuTou.zhi);

      // 获取节气信息
      const prevJieQi = lunar.getPrevJieQi();
      const nextJieQi = lunar.getNextJieQi();

      // 显示结果
      document.getElementById('resultPlaceholder').style.display = 'none';
      document.getElementById('resultContent').classList.add('show');
      document.getElementById('jieqiPlaceholder').style.display = 'none';
      document.getElementById('jieqiContent').classList.add('show');

      // 真太阳时显示
      const trueSolarTimeDisplay = document.getElementById('trueSolarTimeDisplay');
      if (useTrueSolar) {
        trueSolarTimeDisplay.classList.add('show');
        document.getElementById('trueSolarTimeValue').textContent = formatDateTime(calcDate);
      } else {
        trueSolarTimeDisplay.classList.remove('show');
      }

      // 农历日期
      const lunarMonthName = lunar.getMonthInChinese();
      const lunarDayName = lunar.getDayInChinese();
      const lunarYearGanZhi = lunar.getYearInGanZhi();
      document.getElementById('lunarDateValue').textContent = 
        `${lunarYearGanZhi}年 ${lunarMonthName}月${lunarDayName}`;

      // 四柱
      document.getElementById('yearPillar').innerHTML = renderGanZhi(yearGan, yearZhi);
      document.getElementById('monthPillar').innerHTML = renderGanZhi(monthGan, monthZhi);
      document.getElementById('dayPillar').innerHTML = renderGanZhi(dayGan, dayZhi);
      document.getElementById('hourPillar').innerHTML = renderGanZhi(hourGan, hourZhi);

      // 符头和三元
      document.getElementById('futouValue').textContent = fuTou.ganZhi;
      document.getElementById('sanyuanValue').textContent = sanYuan;

      // 节气信息
      const prevJieQiSolar = prevJieQi.getSolar();
      const nextJieQiSolar = nextJieQi.getSolar();
      
      const prevJieQiDate = new Date(
        prevJieQiSolar.getYear(),
        prevJieQiSolar.getMonth() - 1,
        prevJieQiSolar.getDay(),
        prevJieQiSolar.getHour(),
        prevJieQiSolar.getMinute()
      );
      
      const nextJieQiDate = new Date(
        nextJieQiSolar.getYear(),
        nextJieQiSolar.getMonth() - 1,
        nextJieQiSolar.getDay(),
        nextJieQiSolar.getHour(),
        nextJieQiSolar.getMinute()
      );

      document.getElementById('prevJieqiName').textContent = prevJieQi.getName();
      document.getElementById('prevJieqiTime').textContent = formatDateTime(prevJieQiDate);
      document.getElementById('prevJieqiDistance').textContent = getJieQiDistance(inputDate, prevJieQiDate);

      document.getElementById('nextJieqiName').textContent = nextJieQi.getName();
      document.getElementById('nextJieqiTime').textContent = formatDateTime(nextJieQiDate);
      document.getElementById('nextJieqiDistance').textContent = getJieQiDistance(inputDate, nextJieQiDate);

      // 奇门遁甲局数
      const currentJieqi = prevJieQi.getName();
      const qimenJu = getQimenJu(currentJieqi, sanYuan);
      
      document.getElementById('qimenPlaceholder').style.display = 'none';
      document.getElementById('qimenContent').classList.add('show');
      document.getElementById('qimenJieqi').textContent = currentJieqi;
      document.getElementById('qimenSanyuan').textContent = sanYuan;
      document.getElementById('qimenJu').textContent = qimenJu;
      document.getElementById('qimenJu').style.color = '#e74c3c'; // 重置颜色

      // 设置手动调整的默认值
      const isYangDun = qimenJu.startsWith('阳');
      document.getElementById('yinYangSelect').value = isYangDun ? '阳遁' : '阴遁';
      const juNum = qimenJu.replace(/[阳阴遁局]/g, '');
      document.getElementById('juShuSelect').value = juNum;
      updateAdjustedJu();

      // 保存时干支用于手动调整
      currentHourGan = hourGan;
      currentHourZhi = hourZhi;

      // 更新地盘和值符值使
      updateDiPan(qimenJu, hourGan, hourZhi);
    });

    // 更新调整后的局数显示
    function updateAdjustedJu() {
      const yinYang = document.getElementById('yinYangSelect').value;
      const juShu = document.getElementById('juShuSelect').value;
      document.getElementById('adjustedJu').textContent = yinYang + juShu + '局';
    }

    // 监听下拉框变化
    document.getElementById('yinYangSelect').addEventListener('change', updateAdjustedJu);
    document.getElementById('juShuSelect').addEventListener('change', updateAdjustedJu);

    // 确认调整按钮
    document.getElementById('confirmAdjustBtn').addEventListener('click', function() {
      const adjustedJu = document.getElementById('adjustedJu').textContent;
      document.getElementById('qimenJu').textContent = adjustedJu;
      document.getElementById('qimenJu').style.color = '#27ae60';
      // 更新地盘和值符值使
      updateDiPan(adjustedJu, currentHourGan, currentHourZhi);
    });

    // 初始化
    initCitySelect();
    setCurrentTime();
    // 默认选择北京
    citySelect.value = JSON.stringify({ lng: 116.4074, lat: 39.9042 });
    updateCoordDisplay(116.4074, 39.9042);
  </script>
</body>
</html>
